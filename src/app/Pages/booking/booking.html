<div class="booking-container">

  <!-- Steps -->
  <div class="booking-header">
    <h1><i class="fas fa-spa"></i> Book Your Appointment</h1>
    <p class="subtitle">Choose your preferred branch and service</p>
  </div>

  <div class="booking-steps">
    <div class="step" [class.active]="!selectedBranch" [class.completed]="selectedBranch" (click)="goToStep(1)">
      <div class="step-number">1</div>
      <span>Select Branch</span>
    </div>

    <div class="step" [class.active]="selectedBranch && !hasSelectedService" [class.completed]="hasSelectedService" (click)="goToStep(2)">
      <div class="step-number">2</div>
      <span>Choose Service</span>
    </div>

    <div class="step" [class.active]="hasSelectedService && !selectedTime" [class.completed]="selectedTime" (click)="goToStep(3)">
      <div class="step-number">3</div>
      <span>Select Time</span>
    </div>

    <div class="step" [class.active]="selectedTime" (click)="goToStep(4)">
      <div class="step-number">4</div>
      <span>Confirm Booking</span>
    </div>
  </div>

  <!-- Branches -->
  <div class="section-container" *ngIf="!selectedBranch">
    <div class="section-header">
      <h2><i class="fas fa-map-marker-alt"></i> Available Branches</h2>
      <p>Select the branch that works best for you</p>
    </div>

    <div class="card-grid">
      <div *ngFor="let branch of branches"
           class="card"
           [class.selected]="!!selectedBranch && $any(selectedBranch)._id === $any(branch)._id"
           (click)="selectBranch(branch)">
        <div class="checkmark"><i class="fas fa-check"></i></div>
        <div class="card-icon"><i class="fas fa-store"></i></div>
        <h3>{{ branch.name }}</h3>
        <p>{{ branch.city }}</p>
      </div>
    </div>
  </div>

  <!-- Select Service card -->
  <div class="section-container select-service-card" *ngIf="selectedBranch && !selectedTime">
    <div class="section-header">
      <h2><i class="fas fa-spa"></i> Select Service</h2>
      <p>Choose your preferred service</p>
    </div>

    <!-- Service/Course Toggle -->
    <div class="service-type-toggle">
      <button type="button" class="toggle-button" [class.active]="serviceMode === 'single'" (click)="setServiceMode('single')">
        Service
      </button>
      <button type="button" class="toggle-button" [class.active]="serviceMode === 'course'" (click)="setServiceMode('course')">
        Course
      </button>
    </div>

    <!-- Single Service List -->
    <div class="card-grid" *ngIf="serviceMode === 'single'">
      <div *ngFor="let product of products"
           class="card service-card"
           [class.selected]="!!selectedProduct && $any(selectedProduct)._id === $any(product)._id"
           (click)="selectProduct(product)">
        <div class="checkmark"><i class="fas fa-check"></i></div>
        <div class="service-details">
          <h3>{{ product.name }}</h3>
          <p class="price">{{ product.price }} EGP</p>
          <p class="duration"><i class="far fa-clock"></i> {{ product.duration || 60 }} minutes</p>
        </div>
      </div>
    </div>

    <!-- Course (Multiple Services) List -->
    <div class="card-grid" *ngIf="serviceMode === 'course'">
      <div *ngFor="let product of products"
           class="card service-card"
           [class.selected]="(courseSelections[$any(product)._id] || 0) > 0">
        <div class="checkmark"><i class="fas fa-check"></i></div>
        <div class="service-details">
          <h3>{{ product.name }}</h3>
          <p class="price">{{ product.price }} EGP</p>
          <p class="duration"><i class="far fa-clock"></i> {{ product.duration || 60 }} minutes</p>
          <div class="quantity-controls">
            <button type="button" class="qty-btn" (click)="decrementCourse(product)">-</button>
            <span class="qty">{{ courseSelections[$any(product)._id] || 0 }}</span>
            <button type="button" class="qty-btn" (click)="incrementCourse(product)">+</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Course Summary Panel -->
    <div class="course-summary-panel" *ngIf="serviceMode === 'course' && courseItems.length">
      <h3 class="course-summary-title"><i class="fas fa-list"></i> Selected Services</h3>
      <div class="course-summary-list">
        <div class="course-summary-item" *ngFor="let item of courseItems">
          <span class="name">{{ item.product.name }}</span>
          <span class="qty">Ã— {{ item.quantity }}</span>
          <span class="subtotal">{{ item.subtotal | number:'1.0-2' }} EGP</span>
        </div>
      </div>
      <div class="course-summary-breakdown">
        <div class="course-summary-row">
          <span>Subtotal</span>
          <span>{{ courseTotal | number:'1.0-2' }} EGP</span>
        </div>
        <div class="course-summary-row" *ngIf="courseDiscountRate > 0">
          <span>Discount ({{ courseDiscountRate * 100 }}%)</span>
          <span>-{{ courseDiscountAmount | number:'1.0-2' }} EGP</span>
        </div>
        <div class="course-summary-total">
          <span>Total</span>
          <span>{{ courseFinalTotal | number:'1.0-2' }} EGP</span>
        </div>
      </div>
    </div>

    <div class="day-time-row" *ngIf="hasSelectedService && !selectedTime">
      <div class="day-time-panel">
        <div class="panel-column day-control">
          <div class="panel-title">
            <h3>Select Date</h3>
            <p>Choose your preferred appointment date</p>
          </div>

          <div class="date-picker-wrapper">
            <button type="button" class="date-input" (click)="toggleDatePicker()">
              <i class="far fa-calendar-alt"></i>
              <span class="date-input-label">{{ selectedDay || 'Select a date' }}</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </button>

            <div class="date-picker-panel" *ngIf="isDatePickerOpen">
              <div class="date-picker-header">
                <button type="button" class="nav-btn" (click)="changeMonth(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div class="month-label">{{ currentMonth | date:'MMMM yyyy' }}</div>
                <button type="button" class="nav-btn" (click)="changeMonth(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>

              <div class="date-picker-body">
                <div class="weekday-row">
                  <span *ngFor="let wd of weekdayLabels">{{ wd }}</span>
                </div>

                <div class="weeks">
                  <div class="week-row" *ngFor="let week of calendarWeeks">
                    <button
                      type="button"
                      *ngFor="let day of week"
                      class="day-cell"
                      [class.outside]="!day.isCurrentMonth"
                      [class.today]="day.isToday"
                      [class.selected]="selectedDay === day.displayLabel"
                      [disabled]="day.isDisabled"
                      (click)="selectCalendarDate(day)">
                      {{ day.label }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel-column time-control">
          <div class="panel-title">
            <h3>Select Time</h3>
            <p>Available time slots for {{ selectedDay }}</p>
          </div>

          <div class="time-dropdown-wrapper">
            <button type="button" class="time-input" (click)="toggleTimeDropdown()">
              <i class="far fa-clock"></i>
              <span class="time-input-label">{{ selectedTime || 'Choose a timeâ€¦' }}</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </button>

            <div class="time-dropdown-panel" *ngIf="isTimeDropdownOpen">
              <div class="time-option-list">
                <button
                  type="button"
                  *ngFor="let slot of availableTimeSlots"
                  class="time-option"
                  [class.selected]="selectedTime === slot.time"
                  [class.disabled]="!slot.available"
                  [disabled]="!slot.available"
                  (click)="selectTimeFromDropdown(slot)">
                  <span class="time-option-label">{{ slot.time }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary-container" *ngIf="selectedTime && hasSelectedService && selectedBranch">
    <div class="summary-header">
      <h2><i class="fas fa-file-invoice"></i> Booking Summary</h2>
    </div>

    <div class="summary-content">
      <div class="summary-item">
        <span class="label"><i class="fas fa-map-marker-alt"></i> Branch:</span>
        <span class="value">{{ selectedBranch.name }}</span>
      </div>

      <div class="summary-item" *ngIf="serviceMode === 'single'">
        <span class="label"><i class="fas fa-spa"></i> Service:</span>
        <span class="value">{{ selectedProduct?.name }}</span>
      </div>

      <div class="summary-item" *ngIf="serviceMode === 'course'">
        <span class="label"><i class="fas fa-spa"></i> Services:</span>
        <div class="value course-summary-inline">
          <div class="course-summary-inline-item" *ngFor="let item of courseItems">
            {{ item.product.name }} Ã— {{ item.quantity }}
          </div>
        </div>
      </div>

      <div class="summary-item">
        <span class="label"><i class="fas fa-calendar-alt"></i> Day:</span>
        <span class="value">{{ formatDayLabel(selectedDay!) }}</span>
      </div>

      <div class="summary-item">
        <span class="label"><i class="fas fa-clock"></i> Time:</span>
        <span class="value">{{ selectedTime }}</span>
      </div>

    

      <!-- âœ¨ POINTS DISCOUNT CARD - Optional Rewards âœ¨ -->
      <div class="points-discount-card" *ngIf="isAuthenticated && hasSelectedService">
        <div class="points-header">
          <div class="points-icon">
            <i class="fas fa-gift"></i>
          </div>
          <div class="points-text">
            <h3>ðŸ’Ž Redeem Your Points</h3>
            <p>You have <strong>{{ userPoints | number:'1.0-0' }}</strong> points available</p>
          </div>
        </div>

        <div class="points-body">
          <!-- Not enough points message -->
          <div *ngIf="userPoints < 10000" class="points-info-message friendly">
            <i class="fas fa-star"></i>
            <span>Keep booking to earn more points! You'll need 10,000 points to unlock discounts.</span>
          </div>

          <!-- Points redemption option -->
          <div *ngIf="userPoints >= 10000">
            <p class="points-intro">
              <i class="fas fa-sparkles"></i>
              Great news! You can use your points to get a discount on this booking. 
              <strong>This is completely optional</strong> â€” only check the box if you'd like to redeem points.
            </p>

            <!-- Points Selection -->
            <div class="points-selection-section">
              <label class="points-label">How many points would you like to use?</label>
              <p class="points-hint">
                <i class="fas fa-info-circle"></i>
                Points can be redeemed in multiples of 10,000
              </p>

              <!-- Quick Select Buttons -->
              <div class="points-quick-select">
                <button
                  type="button"
                  *ngFor="let option of pointsOptions"
                  class="points-option-btn"
                  [class.selected]="pointsToRedeemInput === option"
                  [disabled]="option > userPoints"
                  (click)="selectPointsOption(option)">
                  {{ option | number:'1.0-0' }} pts
                </button>
              </div>

              <!-- Points Input -->
              <div class="points-input-group">
                <div class="points-input-wrapper">
                  <input
                    type="number"
                    class="points-input"
                    [(ngModel)]="pointsToRedeemInput"
                    [min]="10000"
                    [max]="maxRedeemablePoints"
                    step="10000"
                    placeholder="Or enter custom amount"
                    (change)="validatePointsInput()" />
                  <span class="points-suffix">pts</span>
                </div>
                <div class="points-validation" *ngIf="pointsValidationError">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ pointsValidationError }}
                </div>
              </div>
            </div>

            <!-- Discount Preview -->
            <div class="discount-preview" *ngIf="calculatedDiscount > 0">
              <div class="discount-preview-box">
                <i class="fas fa-tag"></i>
                <div class="discount-preview-text">
                  <strong>{{ calculatedDiscount | number:'1.0-2' }} EGP off</strong>
                  <small>with {{ pointsToRedeemInput | number:'1.0-0' }} points</small>
                </div>
              </div>
            </div>

            <!-- Apply Checkbox -->
            <label class="points-toggle friendly-toggle" *ngIf="isPointsInputValid && calculatedDiscount > 0">
              <input
                type="checkbox"
                [(ngModel)]="applyPointsDiscount" />
              <span class="toggle-text">
                <strong>Yes, apply this discount!</strong>
                <small>I'll save {{ calculatedDiscount | number:'1.0-2' }} EGP</small>
              </span>
            </label>

            <!-- Selected Info -->
            <div *ngIf="applyPointsDiscount && calculatedDiscount > 0" class="applied-discount-info friendly-applied">
              <i class="fas fa-check-circle"></i>
              <span>
                <strong>Discount selected!</strong> 
                You'll save {{ calculatedDiscount | number:'1.0-2' }} EGP at checkout. 
                You can still proceed without using points by unchecking the box above.
              </span>
            </div>

            <!-- No thanks note -->
            <div class="no-points-note" *ngIf="!applyPointsDiscount">
              <i class="fas fa-smile"></i>
              <span>No problem! Just leave this unchecked and pay the full amount. Your points will stay in your account for next time.</span>
            </div>
          </div>
        </div>
      </div>

      <div class="voucher-section" *ngIf="serviceMode === 'single'">
        <div class="voucher-input-group">
          <input 
            type="text" 
            class="voucher-input" 
            placeholder="Enter voucher code"
            [(ngModel)]="voucherCode"
            [disabled]="voucherApplied"
            (keyup.enter)="applyVoucher()">
          <button 
            type="button"
            class="voucher-btn"
            (click)="applyVoucher()"
            *ngIf="!voucherApplied"
            [disabled]="!voucherCode.trim()">
            <i class="fas fa-tag"></i>
            Apply
          </button>
          <button 
            type="button"
            class="voucher-btn remove"
            (click)="clearVoucher()"
            *ngIf="voucherApplied">
            <i class="fas fa-times"></i>
            Remove
          </button>
        </div>
        <div class="voucher-message" *ngIf="voucherMessage" [class.success]="voucherApplied" [class.error]="!voucherApplied">
          {{ voucherMessage }}
        </div>
      </div>
        <!-- Pricing Breakdown -->
      <div class="pricing-breakdown" *ngIf="serviceMode === 'single'">
        <div class="summary-item">
          <span class="label"><i class="fas fa-tag"></i> Original Price:</span>
          <span class="value">{{ (originalProductPrice !== null ? originalProductPrice : (selectedProduct?.price || 0)) | number:'1.0-2' }} EGP</span>
        </div>

        <div class="summary-item voucher-discount" *ngIf="voucherApplied">
          <span class="label"><i class="fas fa-ticket-alt"></i> Voucher Discount:</span>
          <span class="value discount-amount">- {{ voucherDiscount | number:'1.0-2' }} EGP</span>
        </div>
      </div>

      <div class="summary-item total">
        <span class="label"><i class="fas fa-money-bill-wave"></i> Total:</span>
        <span class="value">
          {{ finalTotal | number:'1.0-2' }} EGP
        </span>
      </div>

      <div class="terms-consent">
        <label class="terms-checkbox">
          <input
            type="checkbox"
            [(ngModel)]="termsAccepted"
            [disabled]="isLoading" />
          <span>
            I agree to the
            <button type="button" class="terms-link" (click)="openTerms($event)">Payment Terms &amp; Conditions</button>
          </span>
        </label>
        <div class="terms-error" *ngIf="termsTouched && !termsAccepted">
          Please agree to the Payment Terms &amp; Conditions to proceed.
        </div>
      </div>

      <button (click)="payNow()" class="pay-btn" [disabled]="isLoading || !termsAccepted">
        <i *ngIf="!isLoading" class="fas fa-credit-card"></i>
        <span *ngIf="!isLoading">Confirm & Pay Now</span>
        <div *ngIf="isLoading" class="spinner"></div>
      </button>
    </div>
  </div>

  <div class="terms-overlay" *ngIf="isTermsOpen" (click)="closeTerms()">
    <div class="terms-sheet" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="paymentTermsTitle">
      <div class="terms-header">
        <h3 id="paymentTermsTitle">Payment Terms &amp; Conditions</h3>
        <button type="button" class="terms-close" (click)="closeTerms()">Close</button>
      </div>

      <div class="terms-body">
        <h4>No late arrival</h4>
        <p>Please arrive on time. Late arrival may result in a shortened session without refund.</p>

        <h4>Cancellation policy</h4>
        <p>Cancellations or rescheduling should be made in advance. No-shows or late cancellations may be subject to charges.</p>

        <h4>Spa rules &amp; behavior guidelines</h4>
        <p>Please respect other guests and staff. Keep noise to a minimum, follow hygiene rules, and follow all safety instructions.</p>
      </div>

      <div class="terms-footer">
        <button type="button" class="terms-accept" (click)="acceptTerms()">I Agree</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Processing your request...</p>
  </div>

  <!-- Errors -->
  <div *ngIf="errorMessage" class="error-message">
    <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
  </div>

</div>